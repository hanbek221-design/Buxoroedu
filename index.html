<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#f8fafc" />
  <title>TestMaster ‚Äî BUXORO_EDU</title>

  <!-- Telegram WebApp SDK (Mini App) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
/* Light, clean UI for Telegram WebApp */
:root{
  --bg: #f8fafc;
  --card: rgba(255,255,255,.92);
  --text: #0f172a;
  --muted:#64748b;
  --border: rgba(15,23,42,.10);
  --shadow: 0 22px 50px rgba(2,6,23,.10);
  --shadow2: 0 10px 26px rgba(2,6,23,.08);
  --r: 18px;

  --primary1:#2563eb;
  --primary2:#60a5fa;

  --danger1:#ef4444;
  --danger2:#fb7185;

  --chip:#eef2ff;
  --chipText:#1d4ed8;

  /* Telegram theme fallbacks */
  --tg-bg: var(--bg);
  --tg-text: var(--text);
  --tg-hint: var(--muted);
  --tg-link: #2563eb;
  --tg-btn: var(--primary1);
  --tg-btn-text: #ffffff;
}

*{box-sizing:border-box}
html, body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
  color: var(--text);
  background:
    radial-gradient(900px 520px at 15% 10%, rgba(96,165,250,.22), transparent 55%),
    radial-gradient(900px 520px at 85% 10%, rgba(167,139,250,.20), transparent 55%),
    linear-gradient(180deg, #ffffff, var(--bg));
  padding-bottom: env(safe-area-inset-bottom, 0px);
}

/* Top bar */
.topbar{
  max-width: 1120px;
  margin: 18px auto 0;
  padding: 14px 16px;
  border-radius: 22px;
  background: var(--card);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:42px;height:42px;border-radius:14px;
  background: conic-gradient(from 160deg, #2563eb, #60a5fa, #a78bfa, #2563eb);
  box-shadow: 0 12px 28px rgba(37,99,235,.25);
}
.brand-text .title{font-size:18px;font-weight:900;letter-spacing:.2px}
.brand-text .subtitle{font-size:12px;color:var(--muted);margin-top:2px}

.top-actions{display:flex;align-items:center;gap:10px}

/* Layout */
.wrap{max-width:1120px;margin:12px auto 22px;padding:0 14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width: 920px){ .grid{grid-template-columns:1fr} .topbar{margin:12px 12px 0} }

.card{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  box-shadow: var(--shadow2);
  padding: 16px;
}

.card-head{
  display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
  margin-bottom: 10px;
}
.card-title{font-size:18px;font-weight:900}
.hint{color:var(--muted);font-size:12px;margin-top:4px}
.note{
  margin-top:12px;
  padding:10px 12px;
  border-radius: 14px;
  background: rgba(37,99,235,.06);
  border: 1px dashed rgba(37,99,235,.18);
  color: #1e3a8a;
  font-size: 12px;
}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

.inner{background: rgba(255,255,255,.95)}
.inner-title{font-weight:900;margin-bottom:8px}
.row{display:flex;align-items:center;gap:10px}
.between{justify-content:space-between}
.end{justify-content:flex-end}
.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 680px){ .two{grid-template-columns:1fr} }

label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
input{
  width:100%;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.14);
  background: #ffffff;
  color: var(--text);
  outline: none;
  transition: box-shadow .15s, border-color .15s;
}
input:focus{
  border-color: rgba(37,99,235,.45);
  box-shadow: 0 0 0 4px rgba(37,99,235,.10);
}
input:disabled{
  background: #f1f5f9;
  color: #64748b;
}

.btn{
  padding: 10px 14px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.14);
  background: #ffffff;
  color: var(--text);
  cursor:pointer;
  font-weight: 800;
  transition: transform .12s, box-shadow .12s, border-color .12s;
}
.btn:hover{
  transform: translateY(-1px);
  box-shadow: 0 12px 28px rgba(2,6,23,.12);
  border-color: rgba(15,23,42,.20);
}
.btn:active{transform: translateY(0px) scale(.99)}

.btn.primary{
  color:#fff;
  border: none;
  background: linear-gradient(135deg, var(--primary1), var(--primary2));
  box-shadow: 0 16px 34px rgba(37,99,235,.22);
}
.btn.ghost{
  background: rgba(15,23,42,.04);
}
.pill{
  padding:6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(15,23,42,.03);
  color: #334155;
  font-size: 12px;
  font-weight: 800;
}
.pill.danger{
  background: rgba(239,68,68,.10);
  border-color: rgba(239,68,68,.25);
  color: #991b1b;
}
.tag{
  padding: 7px 10px;
  border-radius: 999px;
  background: var(--chip);
  color: var(--chipText);
  border: 1px solid rgba(37,99,235,.18);
  font-weight: 900;
  font-size: 12px;
}

/* Tools row */
.tools{
  display:grid;
  grid-template-columns: 1fr auto 1fr auto auto;
  gap:10px;
  margin-top: 10px;
}
@media (max-width: 980px){
  .tools{grid-template-columns:1fr; }
}

/* Answer grid */
.answer-grid{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.qrow{
  border-radius: 16px;
  border: 1px dashed rgba(15,23,42,.16);
  padding: 12px;
  background: rgba(15,23,42,.02);
}
.qrow-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.qn{font-weight:900}
.pad{display:flex;gap:10px;flex-wrap:wrap}

/* Variant buttons (rangli) ‚Äî kontrast kuchli */
.opt{
  width:90px;height:52px;
  border-radius: 16px;
  border: 2px solid rgba(15,23,42,.14);
  background: rgba(15,23,42,.02);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-weight: 950;
  letter-spacing:.2px;
  color: #0f172a;
  transition: transform .12s, box-shadow .12s, border-color .12s, background-color .12s, color .12s;
  --c: 37, 99, 235; /* default */
  position: relative;
  user-select: none;
}
.opt:hover{
  transform: translateY(-1px);
  box-shadow: 0 12px 22px rgba(2,6,23,.12);
}
.opt:active{transform: translateY(0px) scale(.99)}

/* Base tint per option ‚Äî oq fon ichida ham aniq ko‚Äòrinsin */
.opt[data-v="A"]{ --c: 37, 99, 235; background: rgba(var(--c), .16); border-color: rgba(var(--c), .42); }
.opt[data-v="B"]{ --c: 34, 197, 94; background: rgba(var(--c), .16); border-color: rgba(var(--c), .42); }
.opt[data-v="C"]{ --c: 245, 158, 11; background: rgba(var(--c), .18); border-color: rgba(var(--c), .46); }
.opt[data-v="D"]{ --c: 236, 72, 153; background: rgba(var(--c), .16); border-color: rgba(var(--c), .42); }

/* Selected ‚Äî admin */
.opt.admin-on{
  background: rgba(var(--c), .26);
  border-color: rgba(var(--c), .75);
  box-shadow: 0 0 0 5px rgba(var(--c), .18);
}

/* Selected ‚Äî user (yanada kuchli) */
.opt.user-on{
  background: rgba(var(--c), .90);
  border-color: rgba(var(--c), 1);
  color: #ffffff;
  box-shadow: 0 0 0 6px rgba(var(--c), .22), 0 18px 36px rgba(2,6,23,.10);
}
.opt.user-on::after{
  content: "‚úì";
  position: absolute;
  right: 10px;
  top: 8px;
  font-size: 14px;
  font-weight: 900;
  opacity: .95;
}

/* Lists */
.list{display:flex;flex-direction:column;gap:12px}
.item{
  border-radius: 18px;
  border: 1px solid rgba(15,23,42,.10);
  background: #ffffff;
  padding: 14px;
  box-shadow: 0 12px 26px rgba(2,6,23,.06);
}
.item-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.item-title{font-weight: 950; font-size: 16px}
.item-meta{color: var(--muted); font-size: 12px; margin-top: 4px}
.item-actions{margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap}

/* Material chips */
.materials{
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.chip{
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(15,23,42,.03);
  color: #0f172a;
  font-weight: 900;
  font-size: 12px;
  cursor:pointer;
}
.chip.video{background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25)}
.chip.pdf{background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.22)}
.chip.analysis{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25)}
.chip:hover{box-shadow: 0 10px 22px rgba(2,6,23,.10); transform: translateY(-1px)}

/* Tables */
.tablewrap{margin-top:12px}
table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px;border:1px solid rgba(15,23,42,.10)}
th,td{padding:10px 10px;border-bottom:1px solid rgba(15,23,42,.08);text-align:left}
th{background: rgba(15,23,42,.03); color:#475569; font-size: 12px; letter-spacing:.35px; text-transform:uppercase}
tr:last-child td{border-bottom:none}
.my-row{background: rgba(37,99,235,.06)}

/* Detail */
.detail{margin-top:12px}

/* Play */
.play{display:flex;flex-direction:column;gap:10px}
.focus{outline: 3px solid rgba(37,99,235,.22); box-shadow: 0 0 0 8px rgba(37,99,235,.10)}
.hidden{display:none!important}

/* Toast */
.toast{
  position:fixed;
  left:50%; bottom:18px;
  transform:translateX(-50%);
  background: rgba(15,23,42,.92);
  color:#fff;
  padding:10px 12px;
  border-radius: 14px;
  opacity: 0;
  pointer-events:none;
  transition: opacity .18s ease;
  max-width: min(560px, calc(100vw - 18px));
  text-align:center;
  box-shadow: 0 16px 40px rgba(0,0,0,.25);
}
.toast.show{opacity:1}


/* Modal */
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:50;padding:14px}
.modal-backdrop{position:absolute;inset:0;background:rgba(2,6,23,.45);backdrop-filter: blur(2px)}
.modal-card{
  position:relative;
  width:min(620px, calc(100vw - 18px));
  border-radius: 18px;
  background: var(--card);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  padding: 14px;
}
.modal-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:8px}
.modal-title{font-weight:950;font-size:16px}
.modal-sub{color:var(--muted);font-size:12px;margin-top:2px}

/* Telegram theme syncing (optional) */
body.tg{
  background: var(--tg-bg);
  color: var(--tg-text);
}

/* Table polish */
tbody tr:hover{background: rgba(2,6,23,.025)}
td b{font-weight: 950}
.my-row{background: rgba(37,99,235,.08)!important}
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="brand-text">
        <div class="title">TestMaster ‚Äî BUXORO_EDU</div>
        <div class="subtitle">Telegram WebApp + Firestore (Cloud)</div>
      </div>
    </div>

    <div class="top-actions">
      <span class="pill">Cloud v1.8</span>
      <button class="btn ghost" id="btnClose" type="button" title="Yopish">Yopish</button>
    </div>
  </header>

  <main class="wrap">
    <!-- AUTH -->
    <section class="grid" id="authGrid">
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Foydalanuvchi</div>
            <div class="hint">Parolsiz: faqat ism</div>
          </div>
          <span class="pill">Student</span>
        </div>

        <label for="userName">Ismingiz</label>
        <input id="userName" placeholder="Masalan: Ali" autocomplete="name" />

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnUserLogin" type="button">Kirish</button>
        </div>

        <div class="note">
          Telegram Mini App ichida ishlaganda, sahifa avtomatik moslashadi.
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Admin kirish</div>
            <div class="hint">Login + kod</div>
          </div>
          <span class="pill danger">Admin</span>
        </div>

        <div class="two">
          <div>
            <label for="adminLogin">Login</label>
            <input id="adminLogin" placeholder="admin login" autocomplete="username" />
          </div>
          <div>
            <label for="adminCode">Kod</label>
            <input id="adminCode" placeholder="kod" type="password" autocomplete="current-password" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnAdminLogin" type="button">Admin sifatida kirish</button>
        </div>

        <div class="note">
          Admin qiymatlari UI‚Äôda saqlanmaydi. (Kod faqat tekshiruv uchun.)
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section class="card hidden" id="adminCard">
      <div class="card-head">
        <div>
          <div class="card-title">Admin ‚Äî boshqaruv</div>
          <div class="hint">Test yaratish / Link biriktirish / O‚Äòchirish</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" id="btnAdminRefresh" type="button">Yangilash</button>
          <button class="btn" id="btnReportLinkOpen" type="button">Yuborish linki</button>
          <button class="btn ghost" id="btnLogoutAdmin" type="button">Chiqish</button>
        </div>
      </div>

      <div class="grid2">
        <div class="card inner">
          <div class="inner-title">Test yaratish</div>

          <label for="tName">Test nomi</label>
          <input id="tName" />

          <label for="tCode">Maxsus kod</label>
          <input id="tCode" />

          <div class="two">
            <div>
              <label for="tCount">Savollar soni</label>
              <input id="tCount" type="number" value="5" min="1" />
            </div>
            <div>
              <label for="tKeyHint">Javoblar</label>
              <input id="tKeyHint" value="A/B/C/D tanlang" disabled />
            </div>
          </div>

          <!-- NEW: 3 ta link (ixtiyoriy) -->
          <div class="links-box">
            <div class="links-title">Materiallar (ixtiyoriy)</div>

            <label for="tVideoLink">üé¨ Video tahlil linki</label>
            <input id="tVideoLink" placeholder="https://youtube.com/... yoki https://t.me/..." />

            <label for="tPdfLink">üìÑ PDF test linki</label>
            <input id="tPdfLink" placeholder="https://drive.google.com/... yoki pdf URL" />

            <label for="tAnalysisLink">üßæ Test tahlili linki (Telegram)</label>
            <input id="tAnalysisLink" placeholder="https://t.me/c/3086001686/2/17260" />

            <div class="hint">
              Video/PDF ‚Äî testdan oldin ochiladi. Test tahlili ‚Äî faqat test yakunlangandan keyin chiqadi.
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn" id="btnBuildGrid" type="button">Javob panellari</button>
            <button class="btn primary" id="btnSaveTest" type="button">Saqlash</button>
          </div>

          <div id="answerGrid" class="answer-grid"></div>
        </div>

        <div class="card inner">
          <div class="inner-title row between">
            <span>Saqlangan testlar</span>
            <span class="pill" id="testsCount">0 ta</span>
          </div>

          <div id="adminTests" class="list"></div>
        </div>
      </div>
    </section>

    <!-- USER -->
    <section class="card hidden" id="userCard">
      <div class="card-head">
        <div>
          <div class="card-title">Testlar</div>
          <div class="hint">Kodni kiriting yoki ro‚Äòyxatdan tanlang</div>
        </div>
        <div class="row" style="gap:8px">
          <span class="tag" id="whoTag">‚Äî</span>
          <button class="btn ghost" id="btnLogoutUser" type="button">Chiqish</button>
        </div>
      </div>

      <div class="tools">
        <input id="codeInput" placeholder="Kod: masalan ENG101" />
        <button class="btn primary" id="btnStartByCode" type="button">Kirish</button>

        <input id="nameSearch" placeholder="Nom bo‚Äòyicha qidirish..." />
        <button class="btn" id="btnShowAll" type="button">Barcha testlar</button>
        <button class="btn" id="btnClearSearch" type="button">Tozalash</button>
      </div>

      <div id="testsList" class="list" style="margin-top:12px"></div>
    </section>

    <!-- PLAY -->
    <section class="card hidden" id="playCard">
      <div class="card-head">
        <div>
          <div class="card-title" id="playTitle">Test</div>
          <div class="hint">A/B/C/D tugmalarini tanlang</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="btnBack1" type="button">‚¨ÖÔ∏è Orqaga</button>
        </div>
      </div>

      <div id="playBody" class="play"></div>

      <div class="row end" style="margin-top:12px">
        <button class="btn primary" id="finishBtn" type="button">Yakunlash (Ctrl+Enter)</button>
      </div>
    </section>

    <!-- RESULTS -->
    <section class="card hidden" id="resultsCard">
      <div class="card-head">
        <div>
          <div class="card-title" id="resTitle">Natijalar</div>
          <div class="hint">Reyting + tafsilot</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="btnBack2" type="button">‚¨ÖÔ∏è Orqaga</button>
          <button class="btn" id="btnSendTg" type="button">üì® Telegramga yuborish</button>
          <button class="btn" id="btnCopy" type="button">üìã Nusxa olish</button>
        </div>
      </div>

      <div id="leaderboardWrap" class="tablewrap"></div>
      <div id="detailWrap" class="detail"></div>
    </section>

    <div class="toast" id="toast"></div>
  </main>
  <script type="module">
// TestMaster ‚Äî Telegram WebApp Ready (Video/PDF/Analysis links)
// Firebase: 10.12.3 (module CDN)

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, getDocs, query, where, writeBatch, limit
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

/* ===== FIREBASE CONFIG (sizning project) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBJNZlgnfh_UI96SLYX_RLLpElbYEozazA",
  authDomain: "buxoroedu-87f52.firebaseapp.com",
  projectId: "buxoroedu-87f52",
  storageBucket: "buxoroedu-87f52.appspot.com",
  messagingSenderId: "444519456395",
  appId: "1:444519456395:web:d8ca35794b173b9e78be8e",
  measurementId: "G-6T2K290W9Y"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* ===== DOM ===== */
const $ = (id)=>document.getElementById(id);
const el = {
  authGrid: $("authGrid"),
  adminCard: $("adminCard"),
  userCard: $("userCard"),
  playCard: $("playCard"),
  resultsCard: $("resultsCard"),

  btnClose: $("btnClose"),
  toast: $("toast"),

  userName: $("userName"),
  btnUserLogin: $("btnUserLogin"),

  adminLogin: $("adminLogin"),
  adminCode: $("adminCode"),
  btnAdminLogin: $("btnAdminLogin"),

  btnAdminRefresh: $("btnAdminRefresh"),
  btnReportLinkOpen: $("btnReportLinkOpen"),
  btnLogoutAdmin: $("btnLogoutAdmin"),

  reportLinkModal: $("reportLinkModal"),
  reportLinkInput: $("reportLinkInput"),
  btnReportLinkSave: $("btnReportLinkSave"),
  btnReportLinkCancel: $("btnReportLinkCancel"),

  tName: $("tName"),
  tCode: $("tCode"),
  tCount: $("tCount"),
  tKeyHint: $("tKeyHint"),
  tVideoLink: $("tVideoLink"),
  tPdfLink: $("tPdfLink"),
  tAnalysisLink: $("tAnalysisLink"),
  btnBuildGrid: $("btnBuildGrid"),
  btnSaveTest: $("btnSaveTest"),
  answerGrid: $("answerGrid"),
  testsCount: $("testsCount"),
  adminTests: $("adminTests"),

  whoTag: $("whoTag"),
  btnLogoutUser: $("btnLogoutUser"),
  codeInput: $("codeInput"),
  btnStartByCode: $("btnStartByCode"),
  nameSearch: $("nameSearch"),
  btnShowAll: $("btnShowAll"),
  btnClearSearch: $("btnClearSearch"),
  testsList: $("testsList"),

  playTitle: $("playTitle"),
  playBody: $("playBody"),
  btnBack1: $("btnBack1"),
  finishBtn: $("finishBtn"),

  resTitle: $("resTitle"),
  btnBack2: $("btnBack2"),
  btnSendTg: $("btnSendTg"),
  btnCopy: $("btnCopy"),
  leaderboardWrap: $("leaderboardWrap"),
  detailWrap: $("detailWrap"),
};

/* ===== Telegram WebApp integration ===== */
const tg = window.Telegram?.WebApp;

// Telegram natijalar yuboriladigan chat/post linki (siz bergan)
let REPORT_LINK = "https://t.me/c/3086001686/18";

function tgInit(){
  if (!tg) return;
  try{
    tg.ready();
    tg.expand?.();
    tg.disableVerticalSwipes?.();
    tg.setHeaderColor?.({color: tg.themeParams?.bg_color || "#ffffff"});
    tg.setBackgroundColor?.(tg.themeParams?.bg_color || "#ffffff");
    applyTgTheme(tg.themeParams);
    document.body.classList.add("tg");

    tg.onEvent?.("themeChanged", ()=>{
      applyTgTheme(tg.themeParams);
      tg.setHeaderColor?.({color: tg.themeParams?.bg_color || "#ffffff"});
      tg.setBackgroundColor?.(tg.themeParams?.bg_color || "#ffffff");
    });
  }catch(_){}
}

function applyTgTheme(p){
  // Telegram themeParams are optional; fallback remains our light theme
  if (!p) return;
  const root = document.documentElement;
  if (p.bg_color) root.style.setProperty("--tg-bg", p.bg_color);
  if (p.text_color) root.style.setProperty("--tg-text", p.text_color);
  if (p.hint_color) root.style.setProperty("--tg-hint", p.hint_color);
  if (p.link_color) root.style.setProperty("--tg-link", p.link_color);
  if (p.button_color) root.style.setProperty("--tg-btn", p.button_color);
  if (p.button_text_color) root.style.setProperty("--tg-btn-text", p.button_text_color);
}

function haptic(type="light"){
  try{ tg?.HapticFeedback?.impactOccurred?.(type); }catch(_){}
}

function showToast(msg){
  el.toast.textContent = msg;
  el.toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> el.toast.classList.remove("show"), 2200);
}


async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(_){
    try{
      prompt("Ctrl+C bilan nusxa oling:", text);
      return false;
    }catch(__){
      return false;
    }
  }
}

// ‚ÄúTelegramga yuborish‚Äù: natijani nusxalab, ko‚Äòrsatilgan Telegram chat/postga olib boradi.
// Eslatma: WebApp ichidan guruhga avtomatik post qilish faqat bot-server orqali bo‚Äòladi.
// Bu tugma sizga eng qulay yo‚Äòl: Copy + Telegramga o'tish.
async function sendResultToTelegram(text){
  if(!text) return showToast("Avval natija chiqsin.");
  await copyToClipboard(text);
  showToast("‚úÖ Nusxa olindi. Telegramda paste qilib yuboring.");
  openAnyLink(REPORT_LINK);
  haptic("light");
}

el.btnClose?.addEventListener("click", ()=>{
  if (tg?.close) tg.close();
  else window.close();
});

tgInit();

/* ===== Link helpers ===== */
function normalizeUrl(u){
  let url = (u||"").trim();
  if(!url) return "";
  if(url.startsWith("t.me/")) url = "https://" + url;
  return url;
}
function isValidUrl(u){
  if(!u) return true;
  // allow https links only for safety/simplicity
  return /^https:\/\//i.test(u);
}
function isTelegramLink(u){
  return /^https:\/\/t\.me\//i.test(u);
}
function openAnyLink(url){
  const u = normalizeUrl(url);
  if(!u) return;

  // Telegram internal open:
  if (tg){
    if (isTelegramLink(u) && typeof tg.openTelegramLink === "function"){
      tg.openTelegramLink(u);
      return;
    }
    if (typeof tg.openLink === "function"){
      tg.openLink(u);
      return;
    }
  }
  window.open(u, "_blank", "noopener,noreferrer");
}

/* ===== Telegram Report Link (admin can change) ===== */
const SETTINGS_DOC = doc(db, "settings", "app");
const LS_REPORT_KEY = "tm_report_link";

function getLocalReportLink(){
  try{ return (localStorage.getItem(LS_REPORT_KEY) || "").trim(); }catch(_){ return ""; }
}
function setLocalReportLink(v){
  try{ localStorage.setItem(LS_REPORT_KEY, v); }catch(_){}
}

async function loadReportLink(){
  // 1) fast local
  const local = normalizeUrl(getLocalReportLink());
  if(local && isTelegramLink(local)){
    REPORT_LINK = local;
  }
  // 2) Firestore (source of truth)
  try{
    const snap = await getDoc(SETTINGS_DOC);
    const v = normalizeUrl(snap.exists() ? (snap.data().reportLink || "") : "");
    if(v && isTelegramLink(v)){
      REPORT_LINK = v;
      setLocalReportLink(v);
    } else {
      // keep default
      setLocalReportLink(REPORT_LINK);
    }
  }catch(_){
    // offline/no-permission: keep local/default
  }

  // Update modal input if present
  if (el.reportLinkInput) el.reportLinkInput.value = REPORT_LINK;
}

async function saveReportLink(newLink){
  const v = normalizeUrl(newLink);
  if(!v) throw new Error("Link bo‚Äòsh bo‚Äòlmasin");
  if(!isTelegramLink(v)) throw new Error("Telegram link bo‚Äòlsin: https://t.me/...");
  await setDoc(SETTINGS_DOC, { reportLink: v, updatedAt: Date.now() }, { merge:true });
  REPORT_LINK = v;
  setLocalReportLink(v);
}

/* Modal open/close */
function openReportModal(){
  if(!el.reportLinkModal) return;
  el.reportLinkInput.value = REPORT_LINK;
  el.reportLinkModal.classList.remove("hidden");
}
function closeReportModal(){
  if(!el.reportLinkModal) return;
  el.reportLinkModal.classList.add("hidden");
}

el.btnReportLinkOpen?.addEventListener("click", async ()=>{
  try{ await loadReportLink(); }catch(_){}
  openReportModal();
});

el.btnReportLinkCancel?.addEventListener("click", closeReportModal);
el.reportLinkModal?.addEventListener("click", (e)=>{
  const a = e.target?.closest("[data-act='close']");
  if(a) closeReportModal();
});

el.btnReportLinkSave?.addEventListener("click", async ()=>{
  try{
    await saveReportLink(el.reportLinkInput.value);
    showToast("‚úÖ Yuborish linki saqlandi.");
    haptic("light");
    closeReportModal();
  }catch(err){
    showToast("‚ùå " + err.message);
  }
});

/* ===== Local: analysis viewed tracking ===== */
const VIEW_KEY = "tm_analysis_viewed_codes";
function getViewed(){
  try{
    const x = JSON.parse(localStorage.getItem(VIEW_KEY) || "[]");
    return Array.isArray(x) ? x : [];
  }catch(_){ return []; }
}
function markViewed(code){
  const v = new Set(getViewed());
  v.add(code);
  try{ localStorage.setItem(VIEW_KEY, JSON.stringify([...v])); }catch(_){}
}
function isViewed(code){
  return getViewed().includes(code);
}

/* ===== DB layer ===== */
const CACHE = { tests:null, ts:0, statsByCode:new Map() };

async function allTests(force=false){
  if(!force && CACHE.tests && (Date.now()-CACHE.ts<15000)) return CACHE.tests;
  const qs = await getDocs(collection(db,"tests"));
  const arr=[]; qs.forEach(d=>arr.push(d.data()));
  arr.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  CACHE.tests=arr; CACHE.ts=Date.now();
  return arr;
}

async function saveTest({name, code, count, key, videoLink, pdfLink, analysisLink}){
  await setDoc(doc(db,"tests", code), {
    name, code, count, key,
    videoLink: videoLink || "",
    pdfLink: pdfLink || "",
    analysisLink: analysisLink || "",
    updatedAt: Date.now()
  });
  CACHE.tests=null;
}

async function setLinks(code, patch){
  await setDoc(doc(db,"tests", code), {...patch, updatedAt: Date.now()}, {merge:true});
  CACHE.tests=null;
}

/* ===== Stats (saqlanadigan ma'lumotlar) =====
  - attempts: nechta ishlagan
  - correctTotal / wrongTotal: jami to'g'ri/xato (urinshlar bo'yicha yig'iladi)
  - lastScore/lastTotal/lastDate: oxirgi urinish ko'rsatkichlari
*/
function statId(code, login){ return `${code}__${login.toLowerCase()}`; }

async function getStat(code, login){
  const snap = await getDoc(doc(db,"stats", statId(code, login)));
  return snap.exists() ? snap.data() : { code, login, attempts:0, correctTotal:0, wrongTotal:0, lastScore:0, lastTotal:0, lastDate:0 };
}

async function saveStat(code, login, patch){
  await setDoc(doc(db,"stats", statId(code, login)), patch, {merge:true});
  // Invalidate cache for this code
  CACHE.statsByCode.delete(code);
}

async function getStatsForCode(code, force=false){
  if(!force && CACHE.statsByCode.has(code)) return CACHE.statsByCode.get(code);
  const qs = await getDocs(query(collection(db,"stats"), where("code","==",code), limit(500)));
  const arr=[]; qs.forEach(d=>arr.push(d.data()));
  // Ranking: correctTotal desc, then attempts asc (kam urinish ‚Äî yuqoriroq), then name
  arr.sort((a,b)=>
    (Number(b.correctTotal||0)-Number(a.correctTotal||0)) ||
    (Number(a.attempts||0)-Number(b.attempts||0)) ||
    (String(a.login||"").localeCompare(String(b.login||"")))
  );
  CACHE.statsByCode.set(code, arr);
  return arr;
}

/* ===== Temp results (12 soat) =====
  - details: savol bo'yicha tafsilot (12 soatda o'chadi)
*/
const TEMP_HOURS = 12;
const TEMP_MS = TEMP_HOURS * 60 * 60 * 1000;

async function upsertTempResult(rec){
  const id = statId(rec.code, rec.login);
  await setDoc(doc(db,"results_temp", id), rec);
}

async function getTempResult(code, login){
  const snap = await getDoc(doc(db,"results_temp", statId(code, login)));
  if(!snap.exists()) return null;
  const d = snap.data();
  if(d.expiresAt && d.expiresAt < Date.now()) return null;
  return d;
}

async function cleanupExpiredTemps(){
  // Client-driven cleanup: kimdir kirganda eskirgan temp natijalarni tozalaydi
  try{
    const qs = await getDocs(query(collection(db,"results_temp"), where("expiresAt","<", Date.now()), limit(200)));
    const refs=[]; qs.forEach(d=>refs.push(d.ref));
    for(let i=0;i<refs.length;i+=450){
      const batch = writeBatch(db);
      refs.slice(i,i+450).forEach(r=>batch.delete(r));
      await batch.commit();
    }
  }catch(_){}
}

/* ===== Delete test deeply ===== */
async function batchDeleteSnap(snap){
  const refs=[]; snap.forEach(d=>refs.push(d.ref));
  for(let i=0;i<refs.length;i+=450){
    const batch = writeBatch(db);
    refs.slice(i,i+450).forEach(r=>batch.delete(r));
    await batch.commit();
  }
}
async function deleteTestDeep(code){
  // delete stats + temp + test doc
  const stSnap = await getDocs(query(collection(db,"stats"), where("code","==",code), limit(500)));
  await batchDeleteSnap(stSnap);
  const tmpSnap = await getDocs(query(collection(db,"results_temp"), where("code","==",code), limit(500)));
  await batchDeleteSnap(tmpSnap);
  await deleteDoc(doc(db,"tests", code));
  CACHE.tests=null;
  CACHE.statsByCode.delete(code);
}
/* ===== Session / Views ===== */
let SESSION = { role:null, login:null };
let ADMIN_KEY = [];
let PLAY = { code:null, key:[], count:0, chosen:[] };
let FOCUS = 0;
let LAST_COPY_TEXT = "";
let CURRENT_TEST = null;
let CURRENT_STATS = [];
let MY_TEMP = null;

function showOnly(section){
  // sections: auth, admin, user, play, results
  el.authGrid.classList.toggle("hidden", section !== "auth");
  el.adminCard.classList.toggle("hidden", section !== "admin");
  el.userCard.classList.toggle("hidden", section !== "user");
  el.playCard.classList.toggle("hidden", section !== "play");
  el.resultsCard.classList.toggle("hidden", section !== "results");
}

function logout(){
  SESSION = {role:null, login:null};
  CURRENT_TEST = null;
  showOnly("auth");
}

el.btnLogoutAdmin.addEventListener("click", logout);
el.btnLogoutUser.addEventListener("click", logout);

function esc(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;", '"':"&quot;","'":"&#039;" }[c]));
}

/* ===== Admin: build answer grid ===== */
function buildAnswerGrid(){
  const cnt = Math.max(1, parseInt(el.tCount.value||"1",10));
  el.answerGrid.innerHTML = "";
  ADMIN_KEY = new Array(cnt).fill(null);

  for(let i=0;i<cnt;i++){
    const row = document.createElement("div");
    row.className = "qrow";
    row.innerHTML = `
      <div class="qrow-head">
        <div class="qn">${i+1}.</div>
        <div class="pill">To‚Äòg‚Äòri variantni tanlang</div>
      </div>
      <div class="pad">
        ${["A","B","C","D"].map(ch=>`<button class="opt" type="button" data-i="${i}" data-v="${ch}">${ch}</button>`).join("")}
      </div>
    `;
    row.addEventListener("click", (e)=>{
      const b = e.target?.closest("button.opt");
      if(!b) return;
      const idx = parseInt(b.dataset.i,10);
      const v = b.dataset.v;
      const pad = row.querySelector(".pad");
      pad.querySelectorAll(".opt").forEach(x=>x.classList.remove("admin-on"));
      b.classList.add("admin-on");
      ADMIN_KEY[idx] = v;
      haptic("light");
    });
    el.answerGrid.appendChild(row);
  }
}
el.btnBuildGrid.addEventListener("click", buildAnswerGrid);
el.tCount.addEventListener("input", ()=>{
  clearTimeout(buildAnswerGrid._t);
  buildAnswerGrid._t = setTimeout(buildAnswerGrid, 200);
});

/* ===== Admin: save test ===== */
el.btnSaveTest.addEventListener("click", async ()=>{
  const name = (el.tName.value||"").trim();
  const code = (el.tCode.value||"").trim();
  const count = Math.max(1, parseInt(el.tCount.value||"1",10));

  const videoLink = normalizeUrl(el.tVideoLink.value);
  const pdfLink = normalizeUrl(el.tPdfLink.value);
  const analysisLink = normalizeUrl(el.tAnalysisLink.value);

  if(!name) return showToast("Test nomini kiriting.");
  if(!code) return showToast("Maxsus kodni kiriting.");

  if(!ADMIN_KEY.length) return showToast("Avval ‚ÄúJavob panellari‚Äùni bosing.");
  if(ADMIN_KEY.length !== count || ADMIN_KEY.some(x=>!x)) return showToast("Har bir savol uchun A/B/C/D tanlang.");

  // Links are optional; if filled, must be https
  if(!isValidUrl(videoLink)) return showToast("Video link xato (https://...)");
  if(!isValidUrl(pdfLink)) return showToast("PDF link xato (https://...)");
  if(analysisLink && !isTelegramLink(analysisLink)) return showToast("Test tahlili link Telegram bo‚Äòlsin: https://t.me/...");

  await saveTest({name, code, count, key: ADMIN_KEY.slice(), videoLink, pdfLink, analysisLink});
  showToast("‚úÖ Test saqlandi.");
  haptic("medium");

  el.tName.value = "";
  el.tCode.value = "";
  el.tCount.value = "5";
  el.tVideoLink.value = "";
  el.tPdfLink.value = "";
  el.tAnalysisLink.value = "";
  el.answerGrid.innerHTML = "";
  ADMIN_KEY = [];

  await renderAdmin();
});

el.btnAdminRefresh.addEventListener("click", ()=>renderAdmin(true));

async function renderAdmin(force=false){
  const tests = await allTests(force);
  el.testsCount.textContent = `${tests.length} ta`;
  el.adminTests.innerHTML = "";

  if(!tests.length){
    el.adminTests.innerHTML = `<div class="item"><div class="item-title">Testlar yo‚Äòq</div><div class="item-meta">Yangi test yarating.</div></div>`;
    return;
  }

  for(const t of tests){
    // PERF: results sonini har test uchun oldindan o‚Äòqimaymiz (admin tez ochilishi uchun)
    const resCount = null;
    const div = document.createElement("div");
    div.className = "item";

    const has = (x)=> !!(t[x] && String(t[x]).trim());
    div.innerHTML = `
      <div class="item-top">
        <div>
          <div class="item-title">${esc(t.name)}</div>
          <div class="item-meta">kod: <b>${esc(t.code)}</b> ‚Ä¢ ${Number(t.count||0)} savol</div>
        </div>
        <span class="pill">Admin</span>
      </div>

      <div class="item-actions">
        <button class="btn" type="button" data-act="res">Natijalar</button>
        <button class="btn" type="button" data-act="copy">Hisobot nusxasi</button>
        <button class="btn" type="button" data-act="sendTg">Telegramga yuborish</button>
        <button class="btn" type="button" data-act="links">Linklar</button>
        <button class="btn ghost" type="button" data-act="del">O‚Äòchirish</button>
      </div>

      <div class="materials">
        ${has("videoLink") ? `<span class="chip video" data-act="openVideo">üé¨ Video</span>` : ``}
        ${has("pdfLink") ? `<span class="chip pdf" data-act="openPdf">üìÑ PDF</span>` : ``}
        ${has("analysisLink") ? `<span class="chip analysis" data-act="openAnalysis">üßæ Tahlil</span>` : ``}
      </div>
    `;

    div.addEventListener("click", async (e)=>{
      const actBtn = e.target?.closest("[data-act]");
      if(!actBtn) return;
      const act = actBtn.dataset.act;

      if(act === "res"){
        await viewResults(t.code);
        return;
      }
      if(act === "copy"){
        await copyAdminReport(t.code);
        return;
      }
      if(act === "sendTg"){
        // Admin: barcha natijalarni Telegramga yuborish (copy + chatga o‚Äòtish)
        const test = (await allTests()).find(x=>x.code===t.code) || t;
        const resArr = await getResults(t.code, 200);
        const text = makeAllStatsText(test, resArr);
        await sendResultToTelegram(text);
        return;
      }
      if(act === "del"){
        if(!confirm(`'${t.code}' testini VA barcha natijalarni o‚Äòchiraymi?`)) return;
        actBtn.textContent = "O‚Äòchirilmoqda...";
        actBtn.disabled = true;
        try{
          await deleteTestDeep(t.code);
          showToast("‚úÖ O‚Äòchirildi.");
          await renderAdmin(true);
        }catch(err){
          showToast("‚ùå Xatolik: " + err.message);
        }finally{
          actBtn.textContent = "O‚Äòchirish";
          actBtn.disabled = false;
        }
        return;
      }
      if(act === "links"){
        const nextVideo = prompt("üé¨ Video tahlil linki (https://...)", t.videoLink || "") ?? null;
        if(nextVideo === null) return;
        const nextPdf = prompt("üìÑ PDF test linki (https://...)", t.pdfLink || "") ?? null;
        if(nextPdf === null) return;
        const nextAnalysis = prompt("üßæ Test tahlili Telegram linki (https://t.me/...)", t.analysisLink || "") ?? null;
        if(nextAnalysis === null) return;

        const v = normalizeUrl(nextVideo);
        const p = normalizeUrl(nextPdf);
        const a = normalizeUrl(nextAnalysis);

        if(!isValidUrl(v)) return showToast("Video link xato (https://...)");
        if(!isValidUrl(p)) return showToast("PDF link xato (https://...)");
        if(a && !isTelegramLink(a)) return showToast("Tahlil link Telegram bo‚Äòlsin: https://t.me/...");

        await setLinks(t.code, { videoLink: v, pdfLink: p, analysisLink: a });
        showToast("‚úÖ Linklar saqlandi.");
        await renderAdmin(true);
        return;
      }

      if(act === "openVideo") openAnyLink(t.videoLink);
      if(act === "openPdf") openAnyLink(t.pdfLink);
      if(act === "openAnalysis") openAnyLink(t.analysisLink);
    });

    el.adminTests.appendChild(div);
  }
}

/* ===== User login ===== */
el.btnUserLogin.addEventListener("click", async ()=>{
  const name = (el.userName.value||"").trim();
  if(!name) return showToast("Ism kiriting.");
  SESSION = { role:"user", login:name };
  el.whoTag.textContent = name;
  try{ localStorage.setItem("tm_last_name", name); }catch(_){}
  await renderUser(true);
  showOnly("user");
  haptic("light");
});

el.userName.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); el.btnUserLogin.click(); }
});

/* ===== Admin login ===== */
el.btnAdminLogin.addEventListener("click", async ()=>{
  const login = (el.adminLogin.value||"").trim();
  const code  = (el.adminCode.value||"").trim();
  if(login.toLowerCase()==="javohir00" && code==="jude857"){
    SESSION = { role:"admin", login:"ADMIN" };
    showOnly("admin");
    await renderAdmin(true);
    haptic("light");
    return;
  }
  showToast("Admin login yoki kod xato.");
});

/* ===== User: list / search ===== */
el.btnShowAll.addEventListener("click", ()=>renderUser(true));
el.btnClearSearch.addEventListener("click", ()=>{
  el.nameSearch.value = "";
  el.testsList.innerHTML = `<div class="item"><div class="item-title">Qidiruv tozalandi</div><div class="item-meta">‚ÄúBarcha testlar‚Äù ni bosing.</div></div>`;
});
el.btnStartByCode.addEventListener("click", async ()=>{
  const code = (el.codeInput.value||"").trim();
  if(!code) return showToast("Kod kiriting.");
  const tests = await allTests();
  const t = tests.find(x => (x.code||"").toLowerCase() === code.toLowerCase());
  if(!t) return showToast("Test topilmadi.");
  await startTest(t.code);
});

el.codeInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); el.btnStartByCode.click(); }
});

el.nameSearch.addEventListener("input", ()=>{
  clearTimeout(el.nameSearch._t);
  el.nameSearch._t = setTimeout(()=>renderUser(false), 180);
});

async function renderUser(force=false){
  const tests = await allTests(force);
  const q = (el.nameSearch.value||"").trim().toLowerCase();
  const list = q ? tests.filter(t => (t.name||"").toLowerCase().includes(q)) : tests;

  el.testsList.innerHTML = "";
  if(!list.length){
    el.testsList.innerHTML = `<div class="item"><div class="item-title">Topilmadi</div><div class="item-meta">Boshqa nom yoki kod bilan urinib ko‚Äòring.</div></div>`;
    return;
  }

  for(const t of list){
    const has = (x)=> !!(t[x] && String(t[x]).trim());
    const div = document.createElement("div");
    div.className = "item";

    // Analysis rule:
    // - video/pdf: always visible if exists
    // - analysis: visible only after test finished + user opened analysis once (isViewed)
    const showAnalysisChip = has("analysisLink");

    div.innerHTML = `
      <div class="item-top">
        <div>
          <div class="item-title">${esc(t.name)}</div>
          <div class="item-meta">kod: <b>${esc(t.code)}</b> ‚Ä¢ ${Number(t.count||0)} savol</div>
        </div>
        <span class="pill">Test</span>
      </div>

      <div class="item-actions">
        <button class="btn primary" type="button" data-act="start">Testni ishlash</button>
        <button class="btn" type="button" data-act="res">Natijalar</button>
      </div>

      <div class="materials">
        ${has("videoLink") ? `<span class="chip video" data-act="video">üé¨ Video tahlil</span>` : ``}
        ${has("pdfLink") ? `<span class="chip pdf" data-act="pdf">üìÑ PDF test</span>` : ``}
        ${showAnalysisChip ? `<span class="chip analysis" data-act="analysis">üßæ Test tahlili</span>` : ``}
      </div>
    `;

    div.addEventListener("click", async (e)=>{
      const a = e.target?.closest("[data-act]");
      if(!a) return;
      const act = a.dataset.act;

      if(act === "start") return startTest(t.code);
      if(act === "res") return viewResults(t.code);
      if(act === "video") return openAnyLink(t.videoLink);
      if(act === "pdf") return openAnyLink(t.pdfLink);
      if(act === "analysis") return openAnyLink(t.analysisLink);
    });

    el.testsList.appendChild(div);
  }
}

/* ===== Play flow ===== */
el.btnBack1.addEventListener("click", ()=>{
  showOnly("user");
  renderUser(false);
});
el.btnBack2.addEventListener("click", ()=>{
  showOnly("user");
  renderUser(false);
});

async function startTest(code){
  const tests = await allTests();
  const t = tests.find(x=>x.code===code);
  if(!t) return showToast("Test topilmadi.");
  // Urinishlar cheksiz: cheklov yo‚Äòq

  CURRENT_TEST = t;
  PLAY = {
    code: t.code,
    key: t.key || [],
    count: Number(t.count||0),
    chosen: new Array(Number(t.count||0)).fill(null)
  };
  FOCUS = 0;
  el.playTitle.textContent = `${t.name} ‚Äî ${PLAY.count} savol`;
  renderPlay();
  showOnly("play");
}

function renderPlay(){
  el.playBody.innerHTML = "";
  for(let i=0;i<PLAY.count;i++){
    const row = document.createElement("div");
    row.className = "qrow";
    row.id = `q_${i}`;
    row.innerHTML = `
      <div class="qrow-head">
        <div class="qn">${i+1}.</div>
        <div class="pill">Variant tanlang</div>
      </div>
      <div class="pad">
        ${["A","B","C","D"].map(ch=>`<button class="opt" type="button" data-i="${i}" data-v="${ch}">${ch}</button>`).join("")}
      </div>
    `;
    row.addEventListener("click", (e)=>{
      const b = e.target?.closest("button.opt");
      if(!b) { setFocus(i); return; }
      const idx = parseInt(b.dataset.i,10);
      const v = b.dataset.v;
      choose(idx, v);
      setFocus(nextUnanswered(idx));
      haptic("light");
    });
    el.playBody.appendChild(row);
  }
  setFocus(0);
}

function setFocus(i){
  if(PLAY.count<=0) return;
  if(i<0) i=0;
  if(i>=PLAY.count) i=PLAY.count-1;
  FOCUS = i;

  el.playBody.querySelectorAll(".qrow").forEach(x=>x.classList.remove("focus"));
  const row = $("q_"+i);
  if(row){
    row.classList.add("focus");
    row.scrollIntoView({block:"nearest", behavior:"smooth"});
  }
}

function choose(i, v){
  PLAY.chosen[i] = v;
  const row = $("q_"+i);
  if(!row) return;
  const pad = row.querySelector(".pad");
  pad.querySelectorAll(".opt").forEach(x=>x.classList.remove("user-on"));
  const btn = pad.querySelector(`.opt[data-v="${v}"]`);
  btn?.classList.add("user-on");
}

function nextUnanswered(from){
  for(let k=from+1;k<PLAY.count;k++){
    if(PLAY.chosen[k] == null) return k;
  }
  return Math.min(from+1, PLAY.count-1);
}

// Hotkeys
document.addEventListener("keydown", (e)=>{
  if(el.playCard.classList.contains("hidden")) return;

  if(e.key === "Enter" && (e.ctrlKey || e.metaKey)){
    e.preventDefault();
    finishTest();
    return;
  }
  if(e.key === "ArrowDown"){ e.preventDefault(); setFocus(FOCUS+1); return; }
  if(e.key === "ArrowUp"){ e.preventDefault(); setFocus(FOCUS-1); return; }

  const map = { a:"A", b:"B", c:"C", d:"D" };
  const k = e.key.toLowerCase();
  if(map[k]){
    e.preventDefault();
    choose(FOCUS, map[k]);
    setFocus(nextUnanswered(FOCUS));
  }
});

el.finishBtn.addEventListener("click", finishTest);

async function finishTest(){
  if(PLAY.chosen.some(x=>x==null)){
    if(!confirm("Ba ºzi savollar belgilanmagan. Baribir yakunlaysizmi?")) return;
  }

  // Score + details
  let score = 0;
  const details = [];
  for(let i=0;i<PLAY.count;i++){
    const correct = PLAY.key[i];
    const chosen = PLAY.chosen[i] || "-";
    const ok = chosen === correct;
    if(ok) score++;
    details.push({ q:i+1, chosen, correct, ok });
  }

  const wrong = PLAY.count - score;

  // Old stat (attempts) ‚Äî birinchi urinishni aniqlash uchun
  const prev = await getStat(PLAY.code, SESSION.login);
  const prevAttempts = Number(prev.attempts||0);

  // Update stats (doimiy)
  const next = {
    code: PLAY.code,
    login: SESSION.login,
    attempts: prevAttempts + 1,
    correctTotal: Number(prev.correctTotal||0) + score,
    wrongTotal: Number(prev.wrongTotal||0) + wrong,
    lastScore: score,
    lastTotal: PLAY.count,
    lastDate: Date.now(),
    updatedAt: Date.now()
  };
  await saveStat(PLAY.code, SESSION.login, next);

  // Temp details (12 soat)
  const tempRec = {
    login: SESSION.login,
    code: PLAY.code,
    score, total: PLAY.count,
    details,
    date: Date.now(),
    expiresAt: Date.now() + TEMP_MS
  };
  await upsertTempResult(tempRec);

  // Natijani ko'rsatish
  await viewResults(PLAY.code, tempRec);
  haptic("medium");

  // 1-marta ishlaganda avtomatik Telegramga yuborish (copy + linkga o'tish)
  if(prevAttempts === 0){
    const tests = await allTests();
    const t = tests.find(x=>x.code===PLAY.code) || CURRENT_TEST || {name:"Test", code:PLAY.code, count: PLAY.count};
    const share = makeCopyText(t, tempRec);
    await sendResultToTelegram(share);
  }
}
/* ===== Results ===== */
function pct(rec){ return Math.round((rec.score/rec.total)*100); }


function makeAllStatsText(test, arr){
  let text = `üèÅ Reyting (12 soatlik tafsilotlar o‚Äòchadi)\nüß™ Test: ${test.name} (${test.code})\nüìù Savollar: ${test.count} ta\nüë• Ishtirokchilar: ${arr.length} ta\n---\n`;
  if(!arr.length){
    text += "Hali natijalar yo‚Äòq.\n";
    return text;
  }
  arr.slice(0, 200).forEach((r,i)=>{
    const total = (Number(r.correctTotal||0) + Number(r.wrongTotal||0));
    const acc = total ? Math.round((Number(r.correctTotal||0) / total) * 100) : 0;
    const badge = i===0 ? "ü•á" : i===1 ? "ü•à" : i===2 ? "ü•â" : "üèÖ";
    text += `${badge} ${i+1}) ${r.login} | urinish: ${Number(r.attempts||0)} | ‚úÖ ${Number(r.correctTotal||0)} | ‚ùå ${Number(r.wrongTotal||0)} | ${acc}%\n`;
  });
  return text;
}

function makeCopyText(test, rec){
  const lines = [];
  lines.push(`üß™ Test: ${test.name} (${test.code})`);
  lines.push(`üë§ Ism: ${rec.login}`);
  lines.push(`üìä Natija: ${rec.score}/${rec.total} ‚Äî ${pct(rec)}%`);
  lines.push("---");
  rec.details.forEach(d=> lines.push(`${d.q}) tanlandi: ${d.chosen} | to‚Äòg‚Äòri: ${d.correct} ${d.ok?"‚úÖ":"‚ùå"}`));
  return lines.join("\n");
}

function renderMyDetail(rec){
  let html = `<div class="item"><div class="item-title">${esc(rec.login)} ‚Äî ${rec.score}/${rec.total} (${pct(rec)}%)</div>`;
  html += `<div class="item-meta" style="margin-top:6px">Tafsilotlar</div>`;
  html += `<div class="tablewrap" style="margin-top:10px">
    <table>
      <thead><tr><th>#</th><th>Tanlangan</th><th>To‚Äòg‚Äòri</th><th>Holat</th></tr></thead>
      <tbody>
        ${rec.details.map(d=>`<tr><td>${d.q}</td><td>${esc(d.chosen)}</td><td>${esc(d.correct)}</td><td>${d.ok ? "‚úÖ" : "‚ùå"}</td></tr>`).join("")}
      </tbody>
    </table>
  </div></div>`;
  return html;
}

async function viewResults(code, justMade=null){
  await cleanupExpiredTemps();

  const tests = await allTests();
  const t = tests.find(x=>x.code===code);
  if(!t) return showToast("Test topilmadi.");
  CURRENT_TEST = t;

  el.resTitle.textContent = `${t.name} ‚Äî Natijalar`;
  showOnly("results");

  // Leaderboard: stats (saqlanadigan)
  const statsArr = await getStatsForCode(code, true);
  CURRENT_STATS = statsArr;

  if(!statsArr.length){
    el.leaderboardWrap.innerHTML = `<div class="item"><div class="item-title">Natijalar yo‚Äòq</div><div class="item-meta">Hali hech kim ishlamagan.</div></div>`;
  }else{
    let h = `<table><thead><tr>
      <th>#</th><th>Ism</th><th>Urinish</th><th>‚úÖ To‚Äòg‚Äòri</th><th>‚ùå Xato</th><th>üìà Aniqlik</th><th>Oxirgi</th>
    </tr></thead><tbody>`;
    statsArr.slice(0, 200).forEach((r,i)=>{
      const mine = SESSION.login && String(r.login) === String(SESSION.login);
      const total = (Number(r.correctTotal||0)+Number(r.wrongTotal||0));
      const acc = total ? Math.round((Number(r.correctTotal||0)/total)*100) : 0;
      const badge = i===0 ? "ü•á" : i===1 ? "ü•à" : i===2 ? "ü•â" : "";
      h += `<tr class="${mine?"my-row":""}">
        <td><b>${badge} ${i+1}</b></td>
        <td>${esc(r.login)}</td>
        <td><b>${Number(r.attempts||0)}</b></td>
        <td><b>${Number(r.correctTotal||0)}</b></td>
        <td><b>${Number(r.wrongTotal||0)}</b></td>
        <td>${acc}%</td>
        <td>${r.lastDate ? new Date(r.lastDate).toLocaleString() : "-"}</td>
      </tr>`;
    });
    h += `</tbody></table>`;
    el.leaderboardWrap.innerHTML = h;
  }

  // My detail: show temp details (12 soat) bo'lsa
  let mineTemp = null;
  if(SESSION.login){
    mineTemp = justMade || await getTempResult(code, SESSION.login);
  }
  MY_TEMP = mineTemp;

  if(mineTemp){
    el.detailWrap.innerHTML = renderMyDetail(mineTemp);
    LAST_COPY_TEXT = makeCopyText(t, mineTemp);
  }else{
    el.detailWrap.innerHTML = `<div class="item">
      <div class="item-title">Tafsilotlar yo‚Äòq</div>
      <div class="item-meta">Savollar bo‚Äòyicha tafsilotlar 12 soatdan keyin o‚Äòchiriladi. Reytingda esa faqat urinishlar va jami to‚Äòg‚Äòri/xato saqlanadi.</div>
    </div>`;
    LAST_COPY_TEXT = "";
  }

  // Materiallar: Video/PDF har doim; Tahlil link bo'lsa har doim ko'rinsin
  const mats = [];
  if(t.videoLink) mats.push({k:"video", text:"üé¨ Video tahlil", url:t.videoLink});
  if(t.pdfLink) mats.push({k:"pdf", text:"üìÑ PDF test", url:t.pdfLink});
  if(t.analysisLink) mats.push({k:"analysis", text:"üßæ Test tahlili", url:t.analysisLink});

  if(mats.length){
    const box = document.createElement("div");
    box.className = "item";
    box.innerHTML = `
      <div class="item-title">Materiallar</div>
      <div class="item-meta">Linklar ustiga bosing</div>
      <div class="materials">
        ${mats.map(m=>`<span class="chip ${m.k}" data-k="${m.k}">${m.text}</span>`).join("")}
      </div>
    `;
    box.addEventListener("click", (e)=>{
      const chip = e.target?.closest(".chip");
      if(!chip) return;
      const k = chip.dataset.k;
      const m = mats.find(x=>x.k===k);
      if(!m) return;
      openAnyLink(m.url);
      haptic("light");
    });
    el.detailWrap.appendChild(box);
  }
}
/* ===== Copy button ===== */
el.btnCopy.addEventListener("click", async ()=>{
  let text = LAST_COPY_TEXT;
  if(!text && CURRENT_TEST){
    // Admin yoki foydalanuvchi natijasi topilmasa, umumiy ro‚Äòyxatni nusxalaymiz
    text = makeAllStatsText(CURRENT_TEST, CURRENT_STATS || []);
  }
  if(!text) return showToast("Avval natija chiqsin.");
  const ok = await copyToClipboard(text);
  showToast(ok ? "‚úÖ Nusxa olindi." : "‚úÖ Nusxa olish oynasi ochildi.");
  haptic("light");
});

el.btnSendTg?.addEventListener("click", async ()=>{
  let text = LAST_COPY_TEXT;
  if(!text && CURRENT_TEST){
    text = makeAllStatsText(CURRENT_TEST, CURRENT_STATS || []);
  }
  await sendResultToTelegram(text);
});


/* ===== Admin report copy ===== */
async function copyAdminReport(code){
  const tests = await allTests();
  const t = tests.find(x=>x.code===code);
  if(!t) return showToast("Test topilmadi.");

  const statsArr = await getStatsForCode(code, true);
  const text = makeAllStatsText(t, statsArr);

  const ok = await copyToClipboard(text);
  showToast(ok ? "‚úÖ Hisobot nusxasi olindi." : "‚úÖ Nusxa olish oynasi ochildi.");
}

/* ===== Boot ===== */
(function boot(){
  try{
    const last = localStorage.getItem("tm_last_name");
    if(last) el.userName.value = last;
  }catch(_){}
  // Report link yuklash (local + Firestore)
  loadReportLink();
  el.testsList.innerHTML = `<div class="item"><div class="item-title">Boshlash</div><div class="item-meta">Ism kiriting yoki admin bo‚Äòlib kiring.</div></div>`;
  showOnly("auth");
})();
</script>
</body>
</html>
